---
phase: 3.5-youtube-integration
plan: 01
subsystem: api
tags: [youtube, invidious, cors, web-audio-api, typescript]

# Dependency graph
requires:
  - phase: 01-audio-foundation
    provides: AudioContext singleton and AudioBuffer decoding pattern
provides:
  - YouTube URL parsing supporting 5 URL formats
  - CORS proxy wrapper for accessing Invidious API
  - Invidious API integration with instance rotation
  - YouTube audio download and decode pipeline
affects: [3.5-youtube-integration Plan 02 (UI integration)]

# Tech tracking
tech-stack:
  added: []
  patterns: [Discriminated union loading states, CORS proxy pattern, Instance rotation for API resilience]

key-files:
  created: [src/types/youtube.ts, src/utils/corsProxy.ts, src/utils/youtubeExtractor.ts]
  modified: []

key-decisions:
  - "CORS proxy required for Invidious API access (public instances lack CORS headers)"
  - "Instance rotation across 3 Invidious instances for resilience"
  - "CORS proxy also wraps audio stream URLs (Google CDN may lack CORS headers)"
  - "Fallback to formatStreams if adaptiveFormats has no audio-only streams"
  - "Discriminated union YoutubeLoadState prevents impossible state combinations"

patterns-established:
  - "YouTube URL parsing: URL constructor + pathname matching (not regex)"
  - "Invidious API query pattern: instance rotation with fallback"
  - "CORS proxy wrapper: configurable proxy service with encodeURIComponent"
  - "Progress callbacks for multi-stage async operations"

# Metrics
duration: 2min
completed: 2026-02-16
---

# Phase 3.5 Plan 01: YouTube Integration Utilities Summary

**YouTube audio extraction via Invidious API with CORS proxy, instance rotation, and 5 URL format support**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-16T20:37:32Z
- **Completed:** 2026-02-16T20:39:24Z
- **Tasks:** 2
- **Files modified:** 3 (all created)

## Accomplishments
- YouTube video ID extraction from 5 URL formats (watch, youtu.be, embed, shorts, live)
- CORS proxy wrapper with configurable proxy services
- Invidious API integration with automatic instance rotation (3 fallback instances)
- Complete YouTube audio pipeline: URL → video ID → CORS-proxied Invidious API → CORS-proxied audio stream → AudioBuffer
- Type-safe loading states using discriminated unions

## Task Commits

Each task was committed atomically:

1. **Task 1: Create YouTube types and CORS proxy utility** - `1b5e672` (feat)
2. **Task 2: Create YouTube extractor with Invidious API integration** - `a37637a` (feat)

## Files Created/Modified
- `src/types/youtube.ts` - YoutubeLoadState discriminated union (4 variants: idle, loading, success, error), Invidious API response types
- `src/utils/corsProxy.ts` - CORS proxy URL wrapper with CORS_PROXIES array and proxiedUrl function
- `src/utils/youtubeExtractor.ts` - extractYoutubeId (5 URL formats), validateYoutubeUrl (user-friendly errors), loadYoutubeAudio (full pipeline with progress callbacks)

## Decisions Made

**CORS Proxy Architecture:**
- All Invidious API calls wrapped in CORS proxy (public instances lack CORS headers per research)
- Audio stream URLs also wrapped in CORS proxy (Google CDN may lack CORS headers)
- Dual proxy options (CORSPROXY.io, CORS.SH) with configurable proxyIndex parameter

**Instance Rotation Strategy:**
- Three Invidious instances (inv.nadeko.net, yewtu.be, invidious.nerdvpn.de)
- Sequential fallback: continue to next instance on failure
- Only throw error if all instances fail

**URL Validation Pattern:**
- Native URL constructor for validation (not regex)
- 11-character video ID validation with [A-Za-z0-9_-]{11} pattern
- Handles youtu.be short URLs and youtube.com long URLs (including www/m subdomains)

**Audio Stream Selection:**
- Filter adaptiveFormats for audio-only streams (type.startsWith('audio/'))
- Sort by bitrate descending, select highest quality
- Fallback to formatStreams[0] with console warning if no audio-only streams found

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required. CORS proxy services are public and require no API keys.

## Next Phase Readiness

**Ready for Plan 02 (UI Integration):**
- YouTube utility layer complete and type-safe
- All exports available for UI consumption: extractYoutubeId, validateYoutubeUrl, loadYoutubeAudio
- YoutubeLoadState discriminated union ready for React state management
- Progress callbacks ready for loading indicators

**Integration points for Plan 02:**
- YoutubeInput component can import validateYoutubeUrl for inline validation
- loadYoutubeAudio can be called from useAudioPlayer.loadFile extended to accept string URLs
- onProgress callback can update loading state with stage descriptions ("Fetching audio info...", "Downloading audio...", "Processing audio...")

**No blockers or concerns.**

## Self-Check: PASSED

---
*Phase: 3.5-youtube-integration*
*Completed: 2026-02-16*
